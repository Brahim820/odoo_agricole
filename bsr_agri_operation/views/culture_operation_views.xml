<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Vue Tree (Liste) -->
    <record id="view_culture_operation_tree" model="ir.ui.view">
        <field name="name">bsr.culture.operation.tree</field>
        <field name="model">bsr.culture.operation</field>
        <field name="arch" type="xml">
            <tree string="Opérations de Culture" 
                  decoration-info="state == 'planned'"
                  decoration-warning="state == 'in_progress'"
                  decoration-success="state == 'completed'"
                  decoration-muted="state == 'cancelled'"
                  decoration-danger="is_delayed == True">
                <field name="sequence"/>
                <field name="name"/>
                <field name="campaign_id"/>
                <field name="operation_type"/>
                <field name="planned_date"/>
                <field name="deadline"/>
                <field name="responsible_id"/>
                <field name="state" widget="badge"/>
                <field name="priority" widget="priority"/>
                <field name="estimated_cost" sum="Total Estimé"/>
                <field name="actual_cost" sum="Total Réel"/>
                <field name="completion_rate" widget="progressbar"/>
                <field name="is_delayed" invisible="1"/>
            </tree>
        </field>
    </record>

    <!-- Vue Form -->
    <record id="view_culture_operation_form" model="ir.ui.view">
        <field name="name">bsr.culture.operation.form</field>
        <field name="model">bsr.culture.operation</field>
        <field name="arch" type="xml">
            <form string="Opération de Culture">
                <header>
                    <button name="action_plan" type="object" string="Planifier" 
                            class="oe_highlight" attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                    <button name="action_ready" type="object" string="Prête" 
                            attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <button name="action_start" type="object" string="Démarrer" 
                            class="oe_highlight" attrs="{'invisible': [('state', 'not in', ['planned', 'ready'])]}"/>
                    <button name="action_pause" type="object" string="Pause" 
                            attrs="{'invisible': [('state', '!=', 'in_progress')]}"/>
                    <button name="action_resume" type="object" string="Reprendre" 
                            class="oe_highlight" attrs="{'invisible': [('state', '!=', 'paused')]}"/>
                    <button name="action_complete" type="object" string="Terminer" 
                            class="oe_highlight" attrs="{'invisible': [('state', 'not in', ['in_progress', 'paused'])]}"/>
                    <button name="action_cancel" type="object" string="Annuler" 
                            attrs="{'invisible': [('state', 'in', ['completed', 'cancelled'])]}"/>
                    <button name="action_reset_to_draft" type="object" string="Remettre en brouillon" 
                            attrs="{'invisible': [('state', '!=', 'cancelled')]}"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,planned,ready,in_progress,completed"/>
                </header>
                <sheet>
                    <!-- Champs invisibles pour les attrs -->
                    <field name="is_delayed" invisible="1"/>
                    <field name="completion_rate" invisible="1"/>
                    <field name="delay_days" invisible="1"/>
                    
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_view_progress" icon="fa-clock-o" 
                                attrs="{'invisible': [('completion_rate', '=', 0)]}">
                            <field name="completion_rate" widget="statinfo" string="Progression"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_view_delay" icon="fa-exclamation-triangle"
                                attrs="{'invisible': [('is_delayed', '=', False)]}">
                            <field name="delay_days" widget="statinfo" string="Retard (jours)"/>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Nom de l'opération"/>
                        </h1>
                        <h2>
                            <field name="sequence" readonly="1"/>
                        </h2>
                    </div>

                    <group>
                        <group name="main_info">
                            <field name="campaign_id" options="{'no_create': True}"/>
                            <field name="culture_id"/>
                            <field name="farm_id"/>
                            <field name="parcel_id"/>
                            <field name="operation_type"/>
                            <field name="priority" widget="priority"/>
                        </group>
                        <group name="planning">
                            <field name="planned_date"/>
                            <field name="planned_duration" widget="float_time"/>
                            <field name="deadline"/>
                            <field name="work_area"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Exécution" name="execution">
                            <group>
                                <group name="actual_timing">
                                    <field name="actual_start"/>
                                    <field name="actual_end"/>
                                    <field name="actual_duration" widget="float_time"/>
                                </group>
                                <group name="weather">
                                    <field name="weather_conditions"/>
                                    <field name="gps_coordinates"/>
                                </group>
                            </group>
                            
                            <group name="quality">
                                <group>
                                    <field name="quality_rating" widget="selection"/>
                                    <field name="yield_quantity"/>
                                    <field name="yield_unit"/>
                                </group>
                            </group>
                        </page>

                        <page string="Ressources" name="resources">
                            <group>
                                <group name="human_resources">
                                    <field name="responsible_id"/>
                                    <field name="employee_ids" widget="many2many_tags"/>
                                    <field name="external_contractor"/>
                                </group>
                                <group name="equipment">
                                    <field name="equipment_ids" widget="many2many_tags"/>
                                    <field name="vehicle_ids" widget="many2many_tags"/>
                                    <field name="tool_ids" widget="many2many_tags"/>
                                </group>
                            </group>
                        </page>

                        <page string="Produits" name="products">
                            <field name="product_line_ids">
                                <tree editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="product_id"/>
                                    <field name="quantity"/>
                                    <field name="uom_id"/>
                                    <field name="application_rate"/>
                                    <field name="application_method"/>
                                    <field name="unit_cost"/>
                                    <field name="total_cost"/>
                                </tree>
                            </field>
                        </page>

                        <page string="Coûts" name="costs">
                            <group>
                                <group>
                                    <field name="estimated_cost"/>
                                    <field name="actual_cost"/>
                                    <field name="currency_id"/>
                                </group>
                            </group>
                        </page>

                        <page string="Notes" name="notes">
                            <group>
                                <field name="description"/>
                                <field name="internal_notes"/>
                                <field name="client_notes"/>
                            </group>
                            <field name="attachment_ids" widget="many2many_binary"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vue Calendar -->
    <record id="view_culture_operation_calendar" model="ir.ui.view">
        <field name="name">bsr.culture.operation.calendar</field>
        <field name="model">bsr.culture.operation</field>
        <field name="arch" type="xml">
            <calendar string="Calendrier des Opérations" 
                      date_start="planned_date"
                      date_stop="deadline" 
                      color="operation_type"
                      mode="month"
                      quick_add="True">
                <field name="name"/>
                <field name="operation_type"/>
                <field name="state"/>
                <field name="responsible_id"/>
                <field name="campaign_id"/>
                <field name="priority"/>
            </calendar>
        </field>
    </record>

    <!-- Vue Kanban -->
    <record id="view_culture_operation_kanban" model="ir.ui.view">
        <field name="name">bsr.culture.operation.kanban</field>
        <field name="model">bsr.culture.operation</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="name"/>
                <field name="operation_type"/>
                <field name="planned_date"/>
                <field name="state"/>
                <field name="priority"/>
                <field name="responsible_id"/>
                <field name="campaign_id"/>
                <field name="completion_rate"/>
                <field name="is_delayed"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary">
                                        <strong><field name="name"/></strong>
                                    </div>
                                    <div class="o_secondary">
                                        <field name="operation_type"/>
                                    </div>
                                </div>
                                <div class="o_kanban_manage_button_section">
                                    <a class="o_kanban_manage_toggle_button" href="#">
                                        <i class="fa fa-ellipsis-v" role="img" aria-label="Manage" title="Manage"/>
                                    </a>
                                </div>
                            </div>
                            
                            <div class="o_kanban_card_content">
                                <div class="o_kanban_card_main">
                                    <div class="row">
                                        <div class="col-8">
                                            <strong><field name="campaign_id"/></strong>
                                        </div>
                                        <div class="col-4 text-right">
                                            <field name="priority" widget="priority"/>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-12">
                                            <i class="fa fa-calendar"/> <field name="planned_date" widget="date"/>
                                        </div>
                                    </div>
                                    
                                    <div t-if="record.completion_rate.value > 0" class="row">
                                        <div class="col-12">
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar" 
                                                     t-att-style="'width: ' + record.completion_rate.value + '%'">
                                                    <t t-esc="Math.round(record.completion_rate.value)"/>%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_card_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <div t-if="record.is_delayed.raw_value" 
                                             class="badge badge-danger">
                                            <i class="fa fa-exclamation-triangle"/> En retard
                                        </div>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <img t-att-src="kanban_image('hr.employee', 'avatar_128', record.responsible_id.raw_value)"
                                             t-att-title="record.responsible_id.value"
                                             width="24" height="24" class="oe_kanban_avatar"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Search -->
    <record id="view_culture_operation_search" model="ir.ui.view">
        <field name="name">bsr.culture.operation.search</field>
        <field name="model">bsr.culture.operation</field>
        <field name="arch" type="xml">
            <search string="Rechercher des opérations">
                <field name="name" string="Nom"/>
                <field name="sequence"/>
                <field name="campaign_id"/>
                <field name="culture_id"/>
                <field name="operation_type"/>
                <field name="responsible_id"/>
                
                <filter string="Mes opérations" name="my_operations" 
                        domain="[('responsible_id.user_id', '=', uid)]"/>
                <filter string="En retard" name="delayed" 
                        domain="[('is_delayed', '=', True)]"/>
                <filter string="Aujourd'hui" name="today"
                        domain="[('planned_date', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))),
                                 ('planned_date', '&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59)))]"/>
                <filter string="Cette semaine" name="this_week"
                        domain="[('planned_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('planned_date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                
                <separator/>
                <filter string="Brouillon" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Planifiée" name="planned" domain="[('state', '=', 'planned')]"/>
                <filter string="En cours" name="in_progress" domain="[('state', '=', 'in_progress')]"/>
                <filter string="Terminée" name="completed" domain="[('state', '=', 'completed')]"/>
                
                <separator/>
                <group expand="0" string="Grouper par">
                    <filter string="État" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Campagne" name="group_campaign" context="{'group_by': 'campaign_id'}"/>
                    <filter string="Type d'opération" name="group_type" context="{'group_by': 'operation_type'}"/>
                    <filter string="Responsable" name="group_responsible" context="{'group_by': 'responsible_id'}"/>
                    <filter string="Date planifiée" name="group_date" context="{'group_by': 'planned_date'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Actions -->
    <record id="action_culture_operation" model="ir.actions.act_window">
        <field name="name">Opérations de Culture</field>
        <field name="res_model">bsr.culture.operation</field>
        <field name="view_mode">kanban,calendar,tree,form</field>
        <field name="context">{
            'search_default_my_operations': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer votre première opération de culture
            </p>
            <p>
                Les opérations de culture permettent de planifier et suivre
                toutes les interventions sur vos parcelles.
            </p>
        </field>
    </record>

    <!-- Actions contextuelles -->
    <record id="action_culture_operation_today" model="ir.actions.act_window">
        <field name="name">Opérations d'Aujourd'hui</field>
        <field name="res_model">bsr.culture.operation</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('planned_date', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))),
                              ('planned_date', '&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59)))]</field>
        <field name="context">{'search_default_my_operations': 1}</field>
    </record>

    <record id="action_culture_operation_delayed" model="ir.actions.act_window">
        <field name="name">Opérations en Retard</field>
        <field name="res_model">bsr.culture.operation</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="domain">[('is_delayed', '=', True)]</field>
        <field name="context">{}</field>
    </record>

</odoo>