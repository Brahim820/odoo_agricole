<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue formulaire programme d'irrigation -->
        <record id="view_irrigation_program_form" model="ir.ui.view">
            <field name="name">bsr.irrigation.program.form</field>
            <field name="model">bsr.irrigation.program</field>
            <field name="arch" type="xml">
                <form string="Programme d'irrigation">
                    <header>
                        <button name="action_activate" string="Activer" type="object" 
                                class="oe_highlight" states="draft,suspended"/>
                        <button name="action_suspend" string="Suspendre" type="object" states="active"/>
                        <button name="action_complete" string="Terminer" type="object" 
                                states="active,suspended"/>
                        <button name="action_cancel" string="Annuler" type="object"/>
                        <button name="action_create_session" string="Créer Session" 
                                type="object" class="btn-primary" states="active"/>
                        <button name="%(action_report_irrigation_program)d" string="Rapport Programme" 
                                type="action" class="btn-secondary" icon="fa-print"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,active,suspended,completed"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_sessions" type="object" class="oe_stat_button" icon="fa-play">
                                <field name="session_count" widget="statbutton" string="Sessions"/>
                            </button>
                            <button name="%(action_irrigation_zone)d" type="action" class="oe_stat_button" 
                                    icon="fa-map-marker" context="{'search_default_zone_id': zone_id}">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Zone</span>
                                </div>
                            </button>
                        </div>
                        
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name" placeholder="Nom du programme d'irrigation"/></h1>
                            <label for="code" class="oe_edit_only"/>
                            <h2><field name="code" placeholder="Code programme"/></h2>
                        </div>
                        
                        <group>
                            <group string="Configuration de base">
                                <field name="zone_id" options="{'no_create': True}"/>
                                <field name="system_id"/>
                                <field name="farm_id"/>
                                <field name="program_type"/>
                                <field name="priority"/>
                            </group>
                            <group string="Période d'activité">
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="active_season"/>
                            </group>
                        </group>
                        
                        <group string="Planification">
                            <group>
                                <field name="frequency_type"/>
                                <field name="frequency_days" attrs="{'invisible': [('frequency_type', '!=', 'custom')]}"/>
                                <field name="preferred_start_time" widget="float_time"/>
                                <field name="max_start_time" widget="float_time"/>
                                <field name="duration_minutes"/>
                            </group>
                            <group string="Jours de la semaine" attrs="{'invisible': [('frequency_type', '!=', 'weekly')]}">
                                <div>
                                    <field name="monday" class="oe_inline"/> <label for="monday">Lundi</label>
                                    <field name="tuesday" class="oe_inline"/> <label for="tuesday">Mardi</label>
                                    <field name="wednesday" class="oe_inline"/> <label for="wednesday">Mercredi</label>
                                </div>
                                <div>
                                    <field name="thursday" class="oe_inline"/> <label for="thursday">Jeudi</label>
                                    <field name="friday" class="oe_inline"/> <label for="friday">Vendredi</label>
                                </div>
                                <div>
                                    <field name="saturday" class="oe_inline"/> <label for="saturday">Samedi</label>
                                    <field name="sunday" class="oe_inline"/> <label for="sunday">Dimanche</label>
                                </div>
                            </group>
                        </group>
                        
                        <group string="Paramètres d'irrigation">
                            <group>
                                <field name="water_volume_target"/>
                                <field name="water_flow_rate"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="Conditions de déclenchement" name="trigger_conditions">
                                <group string="Seuils environnementaux">
                                    <group>
                                        <field name="soil_moisture_threshold"/>
                                        <field name="temperature_min"/>
                                        <field name="temperature_max"/>
                                        <field name="wind_speed_max"/>
                                    </group>
                                    <group>
                                        <field name="stop_if_rain"/>
                                        <field name="rain_threshold_mm" attrs="{'invisible': [('stop_if_rain', '=', False)]}"/>
                                        <field name="stop_if_wet_soil"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Analyses du sol" name="soil_analysis">
                                <group>
                                    <field name="use_soil_analysis"/>
                                </group>
                                <field name="soil_analysis_ids" attrs="{'invisible': [('use_soil_analysis', '=', False)]}">
                                    <tree string="Analyses de référence">
                                        <field name="name"/>
                                        <field name="analysis_date"/>
                                        <field name="overall_status"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Statistiques" name="statistics">
                                <group>
                                    <group>
                                        <field name="last_execution_date" readonly="1"/>
                                        <field name="next_execution_date" readonly="1"/>
                                        <field name="total_water_consumed" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="success_rate" readonly="1" widget="percentage"/>
                                        <field name="average_duration" readonly="1"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Description" name="description">
                                <field name="description" placeholder="Description du programme"/>
                            </page>
                            <page string="Notes" name="notes">
                                <field name="notes" placeholder="Notes et observations"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Vue tree programme d'irrigation -->
        <record id="view_irrigation_program_tree" model="ir.ui.view">
            <field name="name">bsr.irrigation.program.tree</field>
            <field name="model">bsr.irrigation.program</field>
            <field name="arch" type="xml">
                <tree string="Programmes d'irrigation" decoration-info="state=='active'" 
                      decoration-muted="state=='completed'" decoration-warning="state=='suspended'">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="zone_id"/>
                    <field name="farm_id"/>
                    <field name="program_type"/>
                    <field name="priority" widget="priority"/>
                    <field name="frequency_type"/>
                    <field name="next_execution_date"/>
                    <field name="session_count"/>
                    <field name="success_rate" widget="percentage"/>
                    <field name="state" decoration-success="state=='active'" decoration-muted="state=='draft'"/>
                </tree>
            </field>
        </record>

        <!-- Vue kanban programme d'irrigation -->
        <record id="view_irrigation_program_kanban" model="ir.ui.view">
            <field name="name">bsr.irrigation.program.kanban</field>
            <field name="model">bsr.irrigation.program</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="zone_id"/>
                    <field name="priority"/>
                    <field name="state"/>
                    <field name="program_type"/>
                    <field name="next_execution_date"/>
                    <field name="session_count"/>
                    <field name="success_rate"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title"><field name="name"/></strong>
                                            <br/>
                                            <span class="o_kanban_record_subtitle"><field name="code"/></span>
                                        </div>
                                        <span class="oe_kanban_list_many2one">
                                            <field name="zone_id"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div class="d-flex">
                                            <span class="badge badge-pill" t-att-class="record.priority.raw_value === 'critical' ? 'badge-danger' : record.priority.raw_value === 'high' ? 'badge-warning' : 'badge-secondary'">
                                                <field name="priority"/>
                                            </span>
                                            <span class="badge badge-pill badge-light ml-1">
                                                <field name="program_type"/>
                                            </span>
                                        </div>
                                        <br/>
                                        <t t-if="record.next_execution_date.value">
                                            <i class="fa fa-clock-o"/> Prochaine: <field name="next_execution_date"/>
                                            <br/>
                                        </t>
                                        <i class="fa fa-play"/> <field name="session_count"/> sessions
                                        <br/>
                                        <t t-if="record.success_rate.value">
                                            <i class="fa fa-check"/> Réussite: <field name="success_rate"/>%
                                        </t>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_right">
                                            <button name="action_create_session" type="object" 
                                                    class="btn btn-sm btn-success" title="Créer session" 
                                                    t-if="record.state.raw_value === 'active'">
                                                <i class="fa fa-plus"/>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Vue search programme d'irrigation -->
        <record id="view_irrigation_program_search" model="ir.ui.view">
            <field name="name">bsr.irrigation.program.search</field>
            <field name="model">bsr.irrigation.program</field>
            <field name="arch" type="xml">
                <search string="Recherche programmes d'irrigation">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="zone_id"/>
                    <field name="farm_id"/>
                    <field name="program_type"/>
                    <separator/>
                    <filter string="Actifs" name="active_programs" domain="[('state', '=', 'active')]"/>
                    <filter string="Suspendus" name="suspended" domain="[('state', '=', 'suspended')]"/>
                    <filter string="Terminés" name="completed" domain="[('state', '=', 'completed')]"/>
                    <separator/>
                    <filter string="Priorité critique" name="critical" domain="[('priority', '=', 'critical')]"/>
                    <filter string="Priorité élevée" name="high_priority" domain="[('priority', '=', 'high')]"/>
                    <separator/>
                    <filter string="Automatique" name="automatic" domain="[('program_type', '=', 'scheduled')]"/>
                    <filter string="Manuel" name="manual" domain="[('program_type', '=', 'manual')]"/>
                    <filter string="Urgence" name="emergency" domain="[('program_type', '=', 'emergency')]"/>
                    <separator/>
                    <filter string="Quotidien" name="daily" domain="[('frequency_type', '=', 'daily')]"/>
                    <filter string="Hebdomadaire" name="weekly" domain="[('frequency_type', '=', 'weekly')]"/>
                    <separator/>
                    <filter string="Prochaine exécution aujourd'hui" name="today" 
                            domain="[('next_execution_date', '&gt;=', (datetime.date.today()).strftime('%Y-%m-%d')), ('next_execution_date', '&lt;', (datetime.date.today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                    <separator/>
                    <group expand="0" string="Grouper par">
                        <filter string="Ferme" name="group_farm" context="{'group_by': 'farm_id'}"/>
                        <filter string="Zone" name="group_zone" context="{'group_by': 'zone_id'}"/>
                        <filter string="Type" name="group_type" context="{'group_by': 'program_type'}"/>
                        <filter string="Priorité" name="group_priority" context="{'group_by': 'priority'}"/>
                        <filter string="Fréquence" name="group_frequency" context="{'group_by': 'frequency_type'}"/>
                        <filter string="État" name="group_state" context="{'group_by': 'state'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action pour programmes d'irrigation -->
        <record id="action_irrigation_program" model="ir.actions.act_window">
            <field name="name">Programmes d'irrigation</field>
            <field name="res_model">bsr.irrigation.program</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{'search_default_active_programs': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer votre premier programme d'irrigation !
                </p>
                <p>
                    Planifiez et automatisez l'irrigation de vos zones selon des critères
                    temporels et environnementaux pour optimiser l'arrosage.
                </p>
            </field>
        </record>

    </data>
</odoo>