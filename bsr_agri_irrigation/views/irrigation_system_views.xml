<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue formulaire système d'irrigation -->
        <record id="view_irrigation_system_form" model="ir.ui.view">
            <field name="name">bsr.irrigation.system.form</field>
            <field name="model">bsr.irrigation.system</field>
            <field name="arch" type="xml">
                <form string="Système d'irrigation">
                    <header>
                        <button name="action_activate" string="Activer" type="object" 
                                class="oe_highlight" states="draft,suspended"/>
                        <button name="action_suspend" string="Suspendre" type="object" states="active"/>
                        <button name="action_set_maintenance" string="Maintenance" type="object" 
                                states="active,suspended"/>
                        <button name="action_set_broken" string="En panne" type="object" 
                                states="active,maintenance"/>
                        <button name="action_archive" string="Archiver" type="object"/>
                        <button name="%(action_report_irrigation_system)d" string="Fiche Technique" 
                                type="action" class="btn-secondary" icon="fa-print"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,active,maintenance,suspended"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_zones" type="object" class="oe_stat_button" icon="fa-map-marker">
                                <field name="zone_count" widget="statbutton" string="Zones"/>
                            </button>
                            <button name="action_view_sessions" type="object" class="oe_stat_button" icon="fa-calendar">
                                <field name="session_count" widget="statbutton" string="Sessions"/>
                            </button>
                            <button name="action_create_maintenance_request" type="object" class="oe_stat_button" icon="fa-wrench">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Maintenance</span>
                                </div>
                            </button>
                        </div>
                        
                        <widget name="web_ribbon" title="Archivé" bg_color="bg-danger" 
                                attrs="{'invisible': [('active', '=', True)]}"/>
                        
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name" placeholder="Nom du système d'irrigation"/></h1>
                            <label for="code" class="oe_edit_only"/>
                            <h2><field name="code" placeholder="Code système"/></h2>
                        </div>
                        
                        <group>
                            <group>
                                <field name="irrigation_type"/>
                                <field name="farm_id" options="{'no_create': True}"/>
                                <field name="equipment_id"/>
                                <field name="installation_date"/>
                                <field name="active" invisible="1"/>
                            </group>
                            <group>
                                <field name="max_flow_rate"/>
                                <field name="max_pressure"/>
                                <field name="coverage_area"/>
                                <field name="water_efficiency"/>
                            </group>
                        </group>
                        
                        <group string="Maintenance">
                            <group>
                                <field name="last_maintenance_date"/>
                                <field name="maintenance_frequency_days"/>
                            </group>
                            <group>
                                <field name="next_maintenance_date"/>
                            </group>
                        </group>
                        
                        <group string="Statistiques d'usage">
                            <group>
                                <field name="total_water_consumed" readonly="1"/>
                                <field name="total_operating_hours" readonly="1"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="Description" name="description">
                                <field name="description" placeholder="Description du système d'irrigation"/>
                            </page>
                            <page string="Consommables" name="consumables">
                                <field name="consumable_ids">
                                    <tree string="Consommables utilisés">
                                        <field name="name"/>
                                        <field name="type"/>
                                        <field name="stock_qty"/>
                                        <field name="stock_uom"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Notes" name="notes">
                                <field name="notes" placeholder="Notes et observations"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Vue tree système d'irrigation -->
        <record id="view_irrigation_system_tree" model="ir.ui.view">
            <field name="name">bsr.irrigation.system.tree</field>
            <field name="model">bsr.irrigation.system</field>
            <field name="arch" type="xml">
                <tree string="Systèmes d'irrigation" decoration-muted="state=='archived'" 
                      decoration-warning="state=='maintenance'" decoration-danger="state=='broken'">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="irrigation_type"/>
                    <field name="farm_id"/>
                    <field name="max_flow_rate"/>
                    <field name="coverage_area"/>
                    <field name="zone_count"/>
                    <field name="total_water_consumed"/>
                    <field name="state" decoration-info="state=='active'" decoration-muted="state=='draft'"/>
                    <field name="active" invisible="1"/>
                </tree>
            </field>
        </record>

        <!-- Vue kanban système d'irrigation -->
        <record id="view_irrigation_system_kanban" model="ir.ui.view">
            <field name="name">bsr.irrigation.system.kanban</field>
            <field name="model">bsr.irrigation.system</field>
            <field name="arch" type="xml">
                <kanban>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="irrigation_type"/>
                    <field name="state"/>
                    <field name="farm_id"/>
                    <field name="zone_count"/>
                    <field name="coverage_area"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title"><field name="name"/></strong>
                                            <br/>
                                            <span class="o_kanban_record_subtitle"><field name="code"/></span>
                                        </div>
                                        <span class="oe_kanban_list_many2one">
                                            <field name="farm_id"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <span class="badge badge-pill">
                                            <field name="irrigation_type"/>
                                        </span>
                                        <br/>
                                        <t t-if="record.coverage_area.value">
                                            <i class="fa fa-map-o"/> <field name="coverage_area"/> ha
                                        </t>
                                        <br/>
                                        <i class="fa fa-map-marker"/> <field name="zone_count"/> zones
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <span class="badge" t-att-class="record.state.raw_value === 'active' ? 'badge-success' : record.state.raw_value === 'maintenance' ? 'badge-warning' : record.state.raw_value === 'broken' ? 'badge-danger' : 'badge-secondary'">
                                                <field name="state"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Vue search système d'irrigation -->
        <record id="view_irrigation_system_search" model="ir.ui.view">
            <field name="name">bsr.irrigation.system.search</field>
            <field name="model">bsr.irrigation.system</field>
            <field name="arch" type="xml">
                <search string="Recherche systèmes d'irrigation">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="farm_id"/>
                    <field name="irrigation_type"/>
                    <separator/>
                    <filter string="Actifs" name="active_systems" domain="[('state', '=', 'active')]"/>
                    <filter string="En maintenance" name="maintenance" domain="[('state', '=', 'maintenance')]"/>
                    <filter string="En panne" name="broken" domain="[('state', '=', 'broken')]"/>
                    <separator/>
                    <filter string="Goutte-à-goutte" name="drip" domain="[('irrigation_type', '=', 'drip')]"/>
                    <filter string="Aspersion" name="sprinkler" domain="[('irrigation_type', '=', 'sprinkler')]"/>
                    <filter string="Micro-aspersion" name="micro_spray" domain="[('irrigation_type', '=', 'micro_spray')]"/>
                    <separator/>
                    <filter string="Archivés" name="inactive" domain="[('active', '=', False)]"/>
                    <separator/>
                    <group expand="0" string="Grouper par">
                        <filter string="Ferme" name="group_farm" context="{'group_by': 'farm_id'}"/>
                        <filter string="Type" name="group_type" context="{'group_by': 'irrigation_type'}"/>
                        <filter string="État" name="group_state" context="{'group_by': 'state'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action pour systèmes d'irrigation -->
        <record id="action_irrigation_system" model="ir.actions.act_window">
            <field name="name">Systèmes d'irrigation</field>
            <field name="res_model">bsr.irrigation.system</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{'search_default_active_systems': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer votre premier système d'irrigation !
                </p>
                <p>
                    Définissez vos équipements d'irrigation avec leurs caractéristiques techniques
                    et associez-les à vos fermes pour optimiser l'arrosage de vos cultures.
                </p>
            </field>
        </record>

    </data>
</odoo>