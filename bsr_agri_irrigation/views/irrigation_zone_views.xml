<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue formulaire zone d'irrigation -->
        <record id="view_irrigation_zone_form" model="ir.ui.view">
            <field name="name">bsr.irrigation.zone.form</field>
            <field name="model">bsr.irrigation.zone</field>
            <field name="arch" type="xml">
                <form string="Zone d'irrigation">
                    <header>
                        <button name="action_activate" string="Activer" type="object" 
                                class="oe_highlight" states="draft,suspended"/>
                        <button name="action_suspend" string="Suspendre" type="object" states="active"/>
                        <button name="action_archive" string="Archiver" type="object"/>
                        <button name="action_create_irrigation_program" string="Nouveau Programme" 
                                type="object" class="btn-primary"/>
                        <button name="action_start_irrigation_session" string="Démarrer Session" 
                                type="object" class="btn-success" states="active"/>
                        <button name="%(action_report_irrigation_zone)d" string="Fiche Zone" 
                                type="action" class="btn-secondary" icon="fa-print"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,active,suspended"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_programs" type="object" class="oe_stat_button" icon="fa-calendar">
                                <field name="program_count" widget="statbutton" string="Programmes"/>
                            </button>
                            <button name="action_view_sessions" type="object" class="oe_stat_button" icon="fa-play">
                                <field name="session_count" widget="statbutton" string="Sessions"/>
                            </button>
                        </div>
                        
                        <widget name="web_ribbon" title="Archivé" bg_color="bg-danger" 
                                attrs="{'invisible': [('active', '=', True)]}"/>
                        
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name" placeholder="Nom de la zone d'irrigation"/></h1>
                            <label for="code" class="oe_edit_only"/>
                            <h2><field name="code" placeholder="Code zone"/></h2>
                        </div>
                        
                        <group>
                            <group string="Localisation">
                                <field name="parcel_id" options="{'no_create': True}"/>
                                <field name="farm_id"/>
                                <field name="system_id" options="{'no_create': True}"/>
                                <field name="surface_area"/>
                                <field name="sequence"/>
                                <field name="active" invisible="1"/>
                            </group>
                            <group string="Coordonnées GPS">
                                <field name="latitude"/>
                                <field name="longitude"/>
                                <field name="elevation"/>
                            </group>
                        </group>
                        
                        <group string="Caractéristiques du sol">
                            <group>
                                <field name="soil_type"/>
                                <field name="slope_percentage"/>
                                <field name="drainage_capacity"/>
                            </group>
                            <group>
                                <field name="culture_id"/>
                                <field name="culture_type_id"/>
                                <field name="water_requirement_daily"/>
                            </group>
                        </group>
                        
                        <group string="Configuration irrigation">
                            <group>
                                <field name="irrigation_frequency_days"/>
                                <field name="irrigation_duration_minutes"/>
                                <field name="water_flow_rate"/>
                            </group>
                            <group>
                                <field name="last_irrigation_date"/>
                                <field name="total_water_consumed"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="Coordonnées GPS détaillées" name="gps_coords">
                                <group>
                                    <field name="gps_coordinates" string="Polygone GPS" 
                                           placeholder="Format: lat1,lng1;lat2,lng2;lat3,lng3;..."/>
                                </group>
                                <div class="alert alert-info" role="alert">
                                    <strong>Format des coordonnées:</strong> 
                                    Latitude,Longitude séparées par des points-virgules pour définir un polygone
                                    <br/>Exemple: 48.8566,2.3522;48.8567,2.3523;48.8568,2.3524
                                </div>
                            </page>
                            <page string="Description" name="description">
                                <field name="description" placeholder="Description de la zone"/>
                            </page>
                            <page string="Notes" name="notes">
                                <field name="notes" placeholder="Notes et observations"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Vue tree zone d'irrigation -->
        <record id="view_irrigation_zone_tree" model="ir.ui.view">
            <field name="name">bsr.irrigation.zone.tree</field>
            <field name="model">bsr.irrigation.zone</field>
            <field name="arch" type="xml">
                <tree string="Zones d'irrigation" decoration-muted="state=='archived'">
                    <field name="sequence" widget="handle"/>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="parcel_id"/>
                    <field name="farm_id"/>
                    <field name="system_id"/>
                    <field name="surface_area"/>
                    <field name="soil_type"/>
                    <field name="culture_id"/>
                    <field name="program_count"/>
                    <field name="last_irrigation_date"/>
                    <field name="state" decoration-info="state=='active'" decoration-muted="state=='draft'"/>
                    <field name="active" invisible="1"/>
                </tree>
            </field>
        </record>

        <!-- Vue kanban zone d'irrigation -->
        <record id="view_irrigation_zone_kanban" model="ir.ui.view">
            <field name="name">bsr.irrigation.zone.kanban</field>
            <field name="model">bsr.irrigation.zone</field>
            <field name="arch" type="xml">
                <kanban>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="surface_area"/>
                    <field name="state"/>
                    <field name="parcel_id"/>
                    <field name="system_id"/>
                    <field name="culture_id"/>
                    <field name="program_count"/>
                    <field name="session_count"/>
                    <field name="last_irrigation_date"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title"><field name="name"/></strong>
                                            <br/>
                                            <span class="o_kanban_record_subtitle"><field name="code"/></span>
                                        </div>
                                        <span class="oe_kanban_list_many2one">
                                            <field name="parcel_id"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <span class="badge badge-pill badge-light">
                                            <i class="fa fa-expand"/> <field name="surface_area"/> ha
                                        </span>
                                        <br/>
                                        <t t-if="record.culture_id.value">
                                            <i class="fa fa-leaf"/> <field name="culture_id"/>
                                            <br/>
                                        </t>
                                        <i class="fa fa-cogs"/> <field name="system_id"/>
                                        <br/>
                                        <i class="fa fa-calendar"/> <field name="program_count"/> programmes
                                        <br/>
                                        <t t-if="record.last_irrigation_date.value">
                                            <i class="fa fa-clock-o"/> <field name="last_irrigation_date"/>
                                        </t>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <span class="badge" t-att-class="record.state.raw_value === 'active' ? 'badge-success' : record.state.raw_value === 'suspended' ? 'badge-warning' : 'badge-secondary'">
                                                <field name="state"/>
                                            </span>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <button name="action_start_irrigation_session" type="object" 
                                                    class="btn btn-sm btn-primary" title="Démarrer session">
                                                <i class="fa fa-play"/>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Vue search zone d'irrigation -->
        <record id="view_irrigation_zone_search" model="ir.ui.view">
            <field name="name">bsr.irrigation.zone.search</field>
            <field name="model">bsr.irrigation.zone</field>
            <field name="arch" type="xml">
                <search string="Recherche zones d'irrigation">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="parcel_id"/>
                    <field name="farm_id"/>
                    <field name="system_id"/>
                    <field name="culture_id"/>
                    <separator/>
                    <filter string="Actives" name="active_zones" domain="[('state', '=', 'active')]"/>
                    <filter string="Suspendues" name="suspended" domain="[('state', '=', 'suspended')]"/>
                    <separator/>
                    <filter string="Avec culture" name="with_culture" domain="[('culture_id', '!=', False)]"/>
                    <filter string="Sans culture" name="without_culture" domain="[('culture_id', '=', False)]"/>
                    <separator/>
                    <filter string="Sol argileux" name="clay_soil" domain="[('soil_type', '=', 'clay')]"/>
                    <filter string="Sol limoneux" name="loam_soil" domain="[('soil_type', '=', 'loam')]"/>
                    <filter string="Sol sableux" name="sand_soil" domain="[('soil_type', '=', 'sand')]"/>
                    <separator/>
                    <filter string="Archivées" name="inactive" domain="[('active', '=', False)]"/>
                    <separator/>
                    <group expand="0" string="Grouper par">
                        <filter string="Ferme" name="group_farm" context="{'group_by': 'farm_id'}"/>
                        <filter string="Parcelle" name="group_parcel" context="{'group_by': 'parcel_id'}"/>
                        <filter string="Système" name="group_system" context="{'group_by': 'system_id'}"/>
                        <filter string="Type de sol" name="group_soil" context="{'group_by': 'soil_type'}"/>
                        <filter string="Culture" name="group_culture" context="{'group_by': 'culture_id'}"/>
                        <filter string="État" name="group_state" context="{'group_by': 'state'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action pour zones d'irrigation -->
        <record id="action_irrigation_zone" model="ir.actions.act_window">
            <field name="name">Zones d'irrigation</field>
            <field name="res_model">bsr.irrigation.zone</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{'search_default_active_zones': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer votre première zone d'irrigation !
                </p>
                <p>
                    Divisez vos parcelles en zones d'irrigation pour optimiser l'arrosage
                    selon les besoins spécifiques de chaque culture et type de sol.
                </p>
            </field>
        </record>

    </data>
</odoo>