<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vue Formulaire Affectation d'Équipe -->
        <record id="view_bsr_team_assignment_form" model="ir.ui.view">
            <field name="name">bsr.team.assignment.form</field>
            <field name="model">bsr.team.assignment</field>
            <field name="arch" type="xml">
                <form string="Affectation d'Équipe">
                    <header>
                        <button name="action_plan" type="object" string="Planifier"
                                attrs="{'invisible': [('state', '!=', 'draft')]}"
                                class="oe_highlight" />
                        <button name="action_confirm" type="object" string="Confirmer"
                                attrs="{'invisible': [('state', '!=', 'planned')]}"
                                class="oe_highlight" />
                        <button name="action_start" type="object" string="Démarrer"
                                attrs="{'invisible': [('state', '!=', 'confirmed')]}"
                                class="oe_highlight" />
                        <button name="action_pause" type="object" string="Pause"
                                attrs="{'invisible': [('state', '!=', 'in_progress')]}" />
                        <button name="action_resume" type="object" string="Reprendre"
                                attrs="{'invisible': [('state', '!=', 'paused')]}"
                                class="oe_highlight" />
                        <button name="action_complete" type="object" string="Terminer"
                                attrs="{'invisible': [('state', 'not in', ['in_progress', 'paused'])]}"
                                class="oe_highlight" />
                        <button name="action_cancel" type="object" string="Annuler"
                                attrs="{'invisible': [('state', 'in', ['completed', 'cancelled'])]}" />
                        
                        <field name="state" widget="statusbar" statusbar_visible="draft,planned,confirmed,in_progress,completed" />
                    </header>
                    
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button type="action" name="%(action_bsr_agri_team)d" 
                                    class="oe_stat_button" icon="fa-users"
                                    context="{'default_id': team_id}">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Voir Équipe</span>
                                </div>
                            </button>
                        </div>
                        
                        <widget name="web_ribbon" title="Terminée" bg_color="bg-success" 
                                attrs="{'invisible': [('state', '!=', 'completed')]}" />
                        <widget name="web_ribbon" title="Annulée" bg_color="bg-danger" 
                                attrs="{'invisible': [('state', '!=', 'cancelled')]}" />
                        <widget name="web_ribbon" title="En retard" bg_color="bg-warning" 
                                attrs="{'invisible': [('is_delayed', '!=', True)]}" />
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1" />
                            </h1>
                            <div>
                                <field name="priority" widget="priority" />
                            </div>
                        </div>
                        
                        <group>
                            <group>
                                <field name="team_id" options="{'no_create': True}" />
                                <field name="operation_id" options="{'no_create': True}" />
                                <field name="campaign_id" readonly="1" />
                                <field name="culture_id" readonly="1" />
                            </group>
                            <group>
                                <field name="farm_id" readonly="1" />
                                <field name="parcel_id" readonly="1" />
                                <field name="company_id" options="{'no_create': True}" groups="base.group_multi_company" />
                                <field name="active" invisible="1" />
                            </group>
                        </group>
                        
                        <notebook>
                            <!-- Onglet Planning -->
                            <page string="Planning" name="planning">
                                <group>
                                    <group string="Dates planifiées">
                                        <field name="start_date" />
                                        <field name="end_date" />
                                        <field name="duration_planned" />
                                    </group>
                                    <group string="Dates effectives">
                                        <field name="actual_start_date" />
                                        <field name="actual_end_date" />
                                        <field name="duration_actual" />
                                    </group>
                                </group>
                                
                                <group string="Performance">
                                    <group>
                                        <field name="delay_hours" />
                                        <field name="is_delayed" />
                                    </group>
                                    <group>
                                        <field name="efficiency_rate" widget="progressbar" />
                                    </group>
                                </group>
                            </page>
                            
                            <!-- Onglet Équipe -->
                            <page string="Équipe" name="team">
                                <group>
                                    <group>
                                        <field name="team_member_ids" invisible="1" />
                                        <field name="member_count" />
                                        <field name="hourly_rate" />
                                    </group>
                                    <group>
                                        <field name="estimated_cost" />
                                        <field name="actual_cost" />
                                    </group>
                                </group>
                                
                                <separator string="Membres affectés" />
                                <field name="assigned_member_ids" nolabel="1"
                                       domain="[('id', 'in', team_member_ids)]">
                                    <tree editable="bottom">
                                        <field name="name" />
                                        <field name="job_title" />
                                        <field name="mobile_phone" />
                                        <field name="employee_skill_ids" widget="many2many_tags" readonly="1" />
                                    </tree>
                                </field>
                                
                                <div class="oe_clear">
                                    <button name="auto_assign_members" type="object" 
                                            string="Affectation automatique" 
                                            class="btn-primary"
                                            attrs="{'invisible': [('state', 'in', ['completed', 'cancelled'])]}" />
                                </div>
                            </page>
                            
                            <!-- Onglet Compétences -->
                            <page string="Compétences" name="skills">
                                <group>
                                    <group>
                                        <field name="required_skill_ids" widget="many2many_tags" />
                                    </group>
                                    <group>
                                        <field name="skill_match_rate" widget="progressbar" />
                                    </group>
                                </group>
                                
                                <separator string="Compétences manquantes" 
                                           attrs="{'invisible': [('missing_skill_ids', '=', [])]}" />
                                <field name="missing_skill_ids" nolabel="1" readonly="1"
                                       attrs="{'invisible': [('missing_skill_ids', '=', [])]}"
                                       widget="many2many_tags" />
                            </page>
                            
                            <!-- Onglet Ressources -->
                            <page string="Ressources" name="resources">
                                <group>
                                    <group string="Équipements">
                                        <field name="equipment_ids" widget="many2many_tags" />
                                    </group>
                                    <group string="Véhicules">
                                        <field name="vehicle_ids" widget="many2many_tags" />
                                    </group>
                                </group>
                                
                                <separator string="Production" />
                                <group>
                                    <group>
                                        <field name="work_area_covered" />
                                        <field name="production_quantity" />
                                        <field name="production_unit" />
                                    </group>
                                </group>
                            </page>
                            
                            <!-- Onglet Conditions -->
                            <page string="Conditions" name="conditions">
                                <group>
                                    <field name="weather_conditions" placeholder="Conditions météorologiques..." />
                                </group>
                                
                                <group>
                                    <field name="work_conditions" placeholder="Conditions de travail..." />
                                </group>
                                
                                <group>
                                    <field name="safety_notes" placeholder="Notes de sécurité..." />
                                </group>
                            </page>
                            
                            <!-- Onglet Évaluation -->
                            <page string="Évaluation" name="evaluation"
                                  attrs="{'invisible': [('state', 'not in', ['completed'])]}">
                                <group>
                                    <group>
                                        <field name="performance_rating" />
                                        <field name="quality_rating" />
                                    </group>
                                </group>
                                
                                <separator string="Retour de l'équipe" />
                                <field name="team_feedback" nolabel="1" 
                                       placeholder="Retour et commentaires de l'équipe..." />
                                
                                <separator string="Notes superviseur" />
                                <field name="supervisor_notes" nolabel="1"
                                       placeholder="Notes et évaluation du superviseur..." />
                            </page>
                            
                            <!-- Onglet Notes -->
                            <page string="Notes" name="notes">
                                <group>
                                    <field name="description" nolabel="1" 
                                           placeholder="Description détaillée de l'affectation..." />
                                </group>
                                
                                <separator string="Notes" />
                                <group>
                                    <field name="notes" nolabel="1" 
                                           placeholder="Notes générales..." />
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    
                    <div class="oe_chatter">
                        <field name="message_follower_ids" />
                        <field name="activity_ids" />
                        <field name="message_ids" />
                    </div>
                </form>
            </field>
        </record>

        <!-- Vue Liste Affectation d'Équipe -->
        <record id="view_bsr_team_assignment_tree" model="ir.ui.view">
            <field name="name">bsr.team.assignment.tree</field>
            <field name="model">bsr.team.assignment</field>
            <field name="arch" type="xml">
                <tree string="Affectations d'Équipe" 
                      decoration-info="state=='planned'" 
                      decoration-warning="state=='confirmed'" 
                      decoration-success="state=='completed'"
                      decoration-danger="state=='cancelled'"
                      decoration-muted="state=='paused'">
                    <field name="name" />
                    <field name="priority" widget="priority" />
                    <field name="team_id" />
                    <field name="operation_id" />
                    <field name="start_date" />
                    <field name="end_date" />
                    <field name="duration_planned" />
                    <field name="duration_actual" />
                    <field name="member_count" />
                    <field name="skill_match_rate" widget="progressbar" />
                    <field name="efficiency_rate" widget="progressbar" />
                    <field name="is_delayed" />
                    <field name="state" />
                    <field name="company_id" groups="base.group_multi_company" />
                </tree>
            </field>
        </record>

        <!-- Vue Calendrier -->
        <record id="view_bsr_team_assignment_calendar" model="ir.ui.view">
            <field name="name">bsr.team.assignment.calendar</field>
            <field name="model">bsr.team.assignment</field>
            <field name="arch" type="xml">
                <calendar string="Planning des Affectations" 
                          date_start="start_date" 
                          date_stop="end_date"
                          color="team_id"
                          mode="month"
                          event_open_popup="true"
                          event_limit="5">
                    <field name="name" />
                    <field name="team_id" />
                    <field name="operation_id" />
                    <field name="state" />
                    <field name="priority" />
                    <field name="assigned_member_ids" />
                </calendar>
            </field>
        </record>

        <!-- Vue Gantt -->
        <record id="view_bsr_team_assignment_gantt" model="ir.ui.view">
            <field name="name">bsr.team.assignment.gantt</field>
            <field name="model">bsr.team.assignment</field>
            <field name="arch" type="xml">
                <gantt string="Gantt des Affectations"
                       date_start="start_date"
                       date_stop="end_date"
                       default_group_by="team_id"
                       color="state"
                       decoration-info="state=='planned'"
                       decoration-warning="state=='confirmed'"
                       decoration-success="state=='completed'"
                       decoration-danger="state=='cancelled'">
                    <field name="name" />
                    <field name="team_id" />
                    <field name="operation_id" />
                    <field name="state" />
                    <field name="priority" />
                </gantt>
            </field>
        </record>

        <!-- Vue Kanban -->
        <record id="view_bsr_team_assignment_kanban" model="ir.ui.view">
            <field name="name">bsr.team.assignment.kanban</field>
            <field name="model">bsr.team.assignment</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_kanban_mobile">
                    <field name="name" />
                    <field name="team_id" />
                    <field name="operation_id" />
                    <field name="start_date" />
                    <field name="end_date" />
                    <field name="state" />
                    <field name="priority" />
                    <field name="member_count" />
                    <field name="skill_match_rate" />
                    <field name="is_delayed" />
                    <field name="efficiency_rate" />
                    
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name" />
                                            </strong>
                                            <br/>
                                            <span class="text-muted">
                                                <field name="operation_id" />
                                            </span>
                                        </div>
                                        
                                        <div class="o_kanban_record_top_right">
                                            <div class="o_kanban_record_activity">
                                                <span class="badge badge-pill" 
                                                      t-attf-class="badge-{{record.priority.raw_value == '3' and 'danger' or record.priority.raw_value == '2' and 'warning' or record.priority.raw_value == '1' and 'info' or 'light'}}"
                                                      t-if="record.priority.raw_value != '0'">
                                                    <t t-if="record.priority.raw_value == '3'">Critique</t>
                                                    <t t-elif="record.priority.raw_value == '2'">Urgent</t>
                                                    <t t-elif="record.priority.raw_value == '1'">Important</t>
                                                </span>
                                                
                                                <span class="badge badge-pill badge-warning" t-if="record.is_delayed.raw_value">
                                                    En retard
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="o_kanban_record_body">
                                        <div class="row">
                                            <div class="col-6">
                                                <span class="fa fa-users" title="Équipe"/>
                                                <field name="team_id" />
                                            </div>
                                            <div class="col-6">
                                                <span class="fa fa-user" title="Membres"/>
                                                <t t-esc="record.member_count.raw_value"/> membres
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-2">
                                            <div class="col-6">
                                                <span class="fa fa-calendar" title="Début"/>
                                                <t t-esc="record.start_date.value.strftime('%d/%m %H:%M')" />
                                            </div>
                                            <div class="col-6">
                                                <span class="fa fa-calendar-check" title="Fin"/>
                                                <t t-esc="record.end_date.value.strftime('%d/%m %H:%M')" />
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <div class="progress mb-1" style="height: 10px;">
                                                    <div class="progress-bar bg-success" role="progressbar" 
                                                         t-attf-style="width: #{record.skill_match_rate.raw_value}%"
                                                         t-attf-title="Correspondance compétences: #{record.skill_match_rate.raw_value}%">
                                                    </div>
                                                </div>
                                                <small class="text-muted">Compétences: <t t-esc="record.skill_match_rate.raw_value"/>%</small>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-1" t-if="record.efficiency_rate.raw_value > 0">
                                            <div class="col-12">
                                                <div class="progress mb-1" style="height: 10px;">
                                                    <div class="progress-bar bg-info" role="progressbar" 
                                                         t-attf-style="width: #{record.efficiency_rate.raw_value}%"
                                                         t-attf-title="Efficacité: #{record.efficiency_rate.raw_value}%">
                                                    </div>
                                                </div>
                                                <small class="text-muted">Efficacité: <t t-esc="record.efficiency_rate.raw_value"/>%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Vue Recherche -->
        <record id="view_bsr_team_assignment_search" model="ir.ui.view">
            <field name="name">bsr.team.assignment.search</field>
            <field name="model">bsr.team.assignment</field>
            <field name="arch" type="xml">
                <search string="Rechercher Affectations">
                    <field name="name" string="Référence" filter_domain="[('name','ilike',self)]" />
                    <field name="team_id" string="Équipe" />
                    <field name="operation_id" string="Opération" />
                    <field name="campaign_id" string="Campagne" />
                    <field name="assigned_member_ids" string="Membres" />
                    <field name="company_id" invisible="1" />
                    
                    <separator />
                    
                    <!-- Filtres par état -->
                    <filter string="En cours" name="in_progress" domain="[('state','=','in_progress')]" />
                    <filter string="Confirmées" name="confirmed" domain="[('state','=','confirmed')]" />
                    <filter string="Planifiées" name="planned" domain="[('state','=','planned')]" />
                    <filter string="Terminées" name="completed" domain="[('state','=','completed')]" />
                    
                    <separator />
                    
                    <!-- Filtres par priorité -->
                    <filter string="Critiques" name="critical" domain="[('priority','=','3')]" />
                    <filter string="Urgentes" name="urgent" domain="[('priority','=','2')]" />
                    <filter string="Importantes" name="important" domain="[('priority','=','1')]" />
                    
                    <separator />
                    
                    <!-- Filtres par timing -->
                    <filter string="Aujourd'hui" name="today" 
                            domain="[('start_date', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))),
                                     ('start_date', '&lt;', datetime.datetime.combine(context_today() + datetime.timedelta(days=1), datetime.time(0,0,0)))]" />
                    <filter string="Cette semaine" name="this_week" 
                            domain="[('start_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                     ('start_date', '&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]" />
                    <filter string="Ce mois" name="this_month" 
                            domain="[('start_date', '&gt;=', context_today().replace(day=1)),
                                     ('start_date', '&lt;', (context_today().replace(day=1) + datetime.timedelta(days=32)).replace(day=1))]" />
                    
                    <separator />
                    
                    <!-- Filtres par performance -->
                    <filter string="Affectations terminées" name="completed" 
                            domain="[('state','=','completed')]" />
                    <filter string="Avec compétences requises" name="with_skills" 
                            domain="[('required_skill_ids','!=',False)]" />
                    <filter string="Priorité élevée" name="high_priority" 
                            domain="[('priority','in',['2','3'])]" />
                    
                    <separator />
                    
                    <filter string="Ma société" name="my_company" domain="[('company_id','=',company_id)]" />
                    
                    <!-- Groupements -->
                    <group expand="0" string="Grouper par">
                        <filter string="État" name="group_state" context="{'group_by':'state'}" />
                        <filter string="Équipe" name="group_team" context="{'group_by':'team_id'}" />
                        <filter string="Opération" name="group_operation" context="{'group_by':'operation_id'}" />
                        <filter string="Campagne" name="group_campaign" context="{'group_by':'campaign_id'}" />
                        <filter string="Priorité" name="group_priority" context="{'group_by':'priority'}" />
                        <filter string="Date début" name="group_start_date" context="{'group_by':'start_date:day'}" />
                        <filter string="Société" name="group_company" context="{'group_by':'company_id'}" groups="base.group_multi_company" />
                    </group>
                </search>
            </field>
        </record>

        <!-- Action principale -->
        <record id="action_bsr_team_assignment" model="ir.actions.act_window">
            <field name="name">Affectations d'Équipe</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">bsr.team.assignment</field>
            <field name="view_mode">kanban,tree,form,calendar,gantt</field>
            <field name="context">{'search_default_in_progress': 1, 'search_default_confirmed': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créer votre première affectation d'équipe
                </p>
                <p>
                    Les affectations permettent de planifier et suivre le travail des équipes
                    sur les opérations agricoles avec un suivi détaillé des performances.
                </p>
            </field>
        </record>

        <!-- Action Planning (vue calendrier par défaut) -->
        <record id="action_bsr_team_assignment_planning" model="ir.actions.act_window">
            <field name="name">Planning des Équipes</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">bsr.team.assignment</field>
            <field name="view_mode">calendar,gantt,kanban,tree,form</field>
            <field name="context">{'search_default_this_week': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Planifier les affectations d'équipe
                </p>
                <p>
                    Utilisez le planning pour visualiser et organiser le travail de vos équipes
                    dans le temps avec les vues calendrier et Gantt.
                </p>
            </field>
        </record>

    </data>
</odoo>